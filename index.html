<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Atlassian Marketplace Keywords</title>
  <style>
    :root{ --bg:#0B1021; --card:#121835; --ink:#E6E9F2; --muted:#A9B0C6; --accent:#4C9AFF; --danger:#FF5630; --chip:#1B2348; --radius:16px; --shadow:0 20px 40px rgba(0,0,0,.35);}  
    html,body{height:100%}
    body{margin:0;background:#0B1021;color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1280px;margin:24px auto 64px;padding:0 20px}
    header{display:flex;gap:16px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0 0 6px;font-size:28px;font-weight:700}
    .sub{color:var(--muted);font-size:13px}
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.00));border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow)}
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;padding:14px;background:var(--card);border-radius:var(--radius)}
    .controls.soft{padding:10px;margin-top:8px}
    label{font-size:12px;color:var(--muted)}
    .chip{background:var(--chip);border:1px solid rgba(255,255,255,.06);border-radius:999px;padding:8px 12px;display:flex;gap:8px;align-items:center}
    .file-input-wrapper{position:relative;display:inline-block}
    .file-input-wrapper input[type="file"]{display:none}
    .file-input-display{cursor:pointer;padding:4px 8px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:var(--ink);font-size:11px;display:inline-block;min-width:150px}
    .btn{cursor:pointer;border:0;border-radius:10px;padding:8px 12px;font-weight:600;color:#0B1021;background:var(--accent)}
    .btn.ghost{background:transparent;color:var(--ink);border:1px solid rgba(255,255,255,.12)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    .card{padding:12px}
    .card h3{margin:4px 6px 10px;font-size:13px;font-weight:600;color:var(--muted);letter-spacing:.2px}
    .chart{height:520px;width:100%;display:flex;align-items:center;justify-content:center;position:relative}
    .short{height:420px}
    .chart .placeholder{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#8EA2E3;font-size:12px;letter-spacing:.2px}
    .status{font-size:12px;color:var(--muted);margin-top:6px;white-space:pre-line}
    input[type="range"]{accent-color:var(--accent)}
    input[type="file"]{color:var(--ink);font-size:12px}
    code.bad{color:var(--danger)}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .mini-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .mini{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:10px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}.chart{height:460px}.short{height:380px}.two-col{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Atlassian Marketplace Keywords Charts (excel-sourced)</h1>
        <div class="sub">Visualises some the data from search keywords and zero searches APIs</div>
        <div id="status" class="status">Status: bootstrapping…</div>
      </div>
    </header>

    <section class="grid">
      <!-- PANEL 1: Data inputs & diagnostics -->
      <div class="panel card" style="grid-column:1 / -1;">
        <h3>Data Inputs & Diagnostics</h3>
        <div class="controls">
          <div class="chip">
            <label>Popular Search Keywords</label>
            <div class="file-input-wrapper">
              <input id="file-source" type="file" accept=".xlsx,.xls" />
              <div id="source-display" class="file-input-display">No file chosen</div>
            </div>
          </div>
          <div class="chip">
            <label>Zero‑Result Keywords</label>
            <div class="file-input-wrapper">
              <input id="file-zero" type="file" accept=".xlsx,.xls" />
              <div id="zero-display" class="file-input-display">No file chosen</div>
            </div>
          </div>
          <button id="btn-demo" class="btn ghost">Load demo</button>
          <button id="btn-test" class="btn ghost">Run smoke tests</button>
        </div>
      </div>

      <!-- PANEL 2: United Race + Zeros with local controls -->
      <div class="panel card" style="grid-column:1 / -1;">
        <h3>Search Dynamics — Bar Chart Race & Zero‑Result Overview</h3>
        <div class="mini-grid">
          <!-- mini: shared controls -->
          <div class="mini" style="grid-column:1 / -1;">
            <div class="controls soft">
              <div class="chip" title="Top N per month (race)">
                <label>Top&nbsp;N</label>
                <input id="topN" type="range" min="5" max="20" value="10" />
                <span id="topNVal">10</span>
              </div>
              <div class="chip" title="Race speed (ms)">
                <label>Speed</label>
                <input id="speed" type="range" min="300" max="3000" value="1200" step="100" />
                <span id="speedVal">1.2s</span>
              </div>
              <button id="btn-play" class="btn">▶ Play</button>
            </div>
          </div>
          <!-- mini: bar race -->
          <div class="mini">
            <div id="race" class="chart" data-testid="race"><div class="placeholder">Loading ECharts…</div></div>
            <div class="status">Uses <code>month</code>, <code>keyword</code>, <code>percentage</code> from <code>Raw</code>. Long labels are auto‑trimmed; hover to see full label.</div>
          </div>
          <!-- mini: zero totals -->
          <div class="mini">
            <div id="zeros" class="chart" data-testid="zeros"><div class="placeholder">Loading ECharts…</div></div>
            <div class="status">Uses <code>sum_count</code> from <code>Monthly_Summary</code> (or rolls up <code>count</code> from <code>Raw</code>).</div>
          </div>
        </div>
      </div>

      <!-- PANEL 3: Trails with local control -->
      <div class="panel card" style="grid-row: span 2;">
        <h3>Keyword Trails — Popular Keywords Over Time</h3>
        <div class="controls soft">
          <div class="chip" title="Trails: number of keywords">
            <label>Trails</label>
            <input id="trailsN" type="range" min="3" max="12" value="6" />
            <span id="trailsNVal">6</span>
          </div>
          <div class="chip" title="Legend pages (2 rows per page)">
            <button id="trailsPrev" class="btn ghost" style="padding:6px 8px">◀</button>
            <span id="trailsPageInfo">1/1</span>
            <button id="trailsNext" class="btn ghost" style="padding:6px 8px">▶</button>
          </div>
        </div>
        <div id="trails" class="chart" data-testid="trails"><div class="placeholder">Awaiting data…</div></div>
        <div class="status">Top N keywords (overall) with their <code>percentage</code> trajectory by month.</div>
      </div>

      <!-- PANEL 4: Heatmap with local controls -->
      <div class="panel card" style="grid-row: span 2;">
        <h3>Zero‑Result Heatmap — Where Users Find Nothing</h3>
        <div class="controls soft">
          <div class="chip" title="Heatmap: top K zero‑result keywords by total count">
            <label>Heatmap&nbsp;TopK</label>
            <input id="heatTopK" type="range" min="8" max="30" value="15" />
            <span id="heatTopKVal">15</span>
          </div>
          <div class="chip" id="heatRangeChip" title="Heatmap: filter month range">
            <label>Heat&nbsp;Range</label>
            <input id="heatStart" type="range" min="0" max="0" value="0" />
            <span id="heatStartVal">–</span>
            <input id="heatEnd" type="range" min="0" max="0" value="0" />
            <span id="heatEndVal">–</span>
          </div>
        </div>
        <div id="heatmap" class="chart" data-testid="heatmap"><div class="placeholder">Awaiting data…</div></div>
        <div class="status">Top K zero‑result keywords by total count across months; darker = more empty searches. Use the range sliders to change the period.</div>
      </div>
    </section>
  </div>

  <script>
  // --- Robust sequential loader with fallbacks ---
  (function(){
    const statusEl = document.getElementById('status');
    const setStatus = (t)=>{ if(statusEl) statusEl.textContent = 'Status: ' + t; };

    function loadScriptSeq(urls, globalName){
      return new Promise((resolve, reject)=>{
        let i = 0;
        const tryNext = ()=>{
          if(i >= urls.length){ reject(new Error('All CDNs failed for '+globalName)); return; }
          const url = urls[i++];
          setStatus(`loading ${globalName} from ${new URL(url).hostname}…`);
          const s = document.createElement('script');
          s.src = url; s.async = true; s.crossOrigin = 'anonymous'; s.referrerPolicy = 'no-referrer';
          s.onload = ()=>{ setTimeout(()=>{ if(window[globalName]){ setStatus(`${globalName} loaded from ${new URL(url).hostname}`); resolve(window[globalName]); } else { tryNext(); } }, 0); };
          s.onerror = ()=>{ setStatus(`${globalName} failed from ${new URL(url).hostname}, trying next…`); tryNext(); };
          document.head.appendChild(s);
        };
        tryNext();
      });
    }

    const ECHARTS_URLS = [
      'https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js',
      'https://unpkg.com/echarts@5.5.0/dist/echarts.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/echarts/5.3.3/echarts.min.js'
    ];
    const XLSX_URLS = [
      'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
      'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js'
    ];

    function boot(){
      Promise.all([
        window.echarts ? Promise.resolve(window.echarts) : loadScriptSeq(ECHARTS_URLS, 'echarts'),
        window.XLSX ? Promise.resolve(window.XLSX) : loadScriptSeq(XLSX_URLS, 'XLSX')
      ]).then(()=>{
        setStatus('libraries ready');
        startApp();
      }).catch(err=>{
        console.error(err);
        setStatus('error: '+ err.message);
      });
    }

    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', boot);
    } else { boot(); }

    // --- App starts only after libs are ready ---
    function startApp(){
      const $ = (sel)=>document.querySelector(sel);
      const setStatus = (t)=> $('#status').textContent = `Status: ${t}`;

      const state = {
        charts: { race: null, zeros: null, trails: null, heatmap: null },
        sourceRaw: [], zeroRaw: [], zeroTotals: [],
        months: [],
        topN: 10, playInterval: 1200, timelinePlaying: false,
        trailsN: 6, heatTopK: 15,
        heatStartIdx: 0, heatEndIdx: 0, trailsLegendPage: 0, trailsLegendCols: 3, trailsLegendRows: 2, trailsLegendTotalPages: 1,
        // default data autoload flags
        manualSource: false, manualZero: false, defaultsTried: false
      };

      // --- Utils ---
      const toMonthKey = (v)=>{
        try{
          if(typeof v === 'number' && window.XLSX && XLSX.SSF){ const d = XLSX.SSF.parse_date_code(v); const date = new Date(Date.UTC(d.y, d.m-1, d.d)); return date.toISOString().slice(0,7); }
          const d = new Date(v); if(!isNaN(d)) return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), 1)).toISOString().slice(0,7);
          return String(v).trim().slice(0,7);
        }catch(e){ return String(v).trim().slice(0,7); }
      };
      const asNumber = (x)=>{ if(x==null) return NaN; const n = Number(String(x).replace(',','.')); return Number.isFinite(n)?n:NaN; };
      const labelTrim = (s, max=18)=>{ s = String(s||''); return s.length>max ? s.slice(0, max-1) + '…' : s; };
      // Wrap to two lines at a sensible point (space if possible), keep start visible
      function wrapLabel(s, max=22){
        s = String(s||'');
        if(s.length <= max) return s;
        const cut = (str, m)=>{
          if(str.length <= m) return [str, ''];
          let i = str.lastIndexOf(' ', m);
          if(i < Math.floor(m*0.6)) i = str.indexOf(' ', m);
          if(i === -1) i = m;
          return [str.slice(0, i), str.slice(i+1)];
        };
        let [l1, rest] = cut(s, max);
        if(rest.length > max){ rest = rest.slice(0, max-1) + '…'; }
        return l1 + '\n' + rest;
      }

      function ensureChart(id){
        const el = document.getElementById(id);
        if(!el){ console.error(`#${id} not found`); return null; }
        const ph = el.querySelector('.placeholder'); if(ph) ph.remove();
        if(state.charts[id] && !state.charts[id].isDisposed?.()) return state.charts[id];
        try{ state.charts[id] = echarts.init(el); return state.charts[id]; }catch(err){ console.error('echarts.init failed', id, err); return null; }
      }
      function safeSetOption(id, option){ const c = ensureChart(id); if(!c){ setStatus(`error: chart #${id} not ready`); return; } c.setOption(option, true); }

      // Grouping helpers
      function groupByMonthTop(list, valueField, topN){
        const by = new Map(); for(const r of list){ const m = toMonthKey(r.month); if(!by.has(m)) by.set(m, []); by.get(m).push(r); }
        const months = Array.from(by.keys()).sort(); const top = {};
        for(const m of months){ top[m] = by.get(m).filter(x=>Number.isFinite(asNumber(x[valueField]))).sort((a,b)=> asNumber(b[valueField]) - asNumber(a[valueField])).slice(0, topN).map(x=>({ name:String(x.keyword||'').trim(), value:asNumber(x[valueField]) })); }
        return { months, topByMonth: top };
      }
      function totalsByMonth(list, valueField){ const acc = new Map(); for(const r of list){ const m = toMonthKey(r.month); acc.set(m,(acc.get(m)||0)+(asNumber(r[valueField])||0)); } return Array.from(acc.entries()).sort((a,b)=>a[0].localeCompare(b[0])).map(([m,v])=>({month:m,value:v})); }

      // --- Chart options ---
      function buildRaceOption(months, topByMonth){
        return { backgroundColor:'transparent', animationDurationUpdate: state.playInterval*0.9, animationEasing:'quarticOut',
          timeline:{ axisType:'category', autoPlay: state.timelinePlaying, playInterval: state.playInterval, data: months, label:{ color:'#C8D1EA' }, lineStyle:{ color:'rgba(255,255,255,.35)' }, controlStyle:{ color:'#fff', borderColor:'rgba(255,255,255,.2)' }, bottom: 0 },
          baseOption:{ grid:{ left:8, right:36, top:40, bottom:90, containLabel:true }, xAxis:{ type:'value', splitLine:{ lineStyle:{ color:'rgba(255,255,255,.08)'} }, axisLabel:{ color:'#BFC7E5', formatter:'{value}%'} }, yAxis:{ type:'category', inverse:true, axisLabel:{ color:'#E6E9F2', margin:6, formatter:(val)=>labelTrim(val, 18) }, axisTick:{ show:false }, axisLine:{ show:false } }, tooltip:{ trigger:'item', borderColor:'rgba(255,255,255,.15)', backgroundColor:'rgba(9,13,31,.96)', textStyle:{ color:'#E6E9F2' }, formatter:p=>`<div><b>${p.name}</b><br/>${p.value} %</div>` }, series:[{ type:'bar', realtimeSort:true, barCategoryGap:'20%', label:{ show:true, position:'right', color:'#E6E9F2', formatter:p=>`${p.value.toFixed(2)}%` }, itemStyle:{ borderRadius:[4,12,12,4], color:(p)=> ['#4C9AFF','#36B37E','#6554C0','#FFAB00','#FF5630','#5E5CE6','#00C7E6','#36B37E','#C0B6F2','#79F2C0'][p.dataIndex%10] } }], graphic:[{ type:'text', left:10, top:6, style:{ text:'Popular Keywords', fill:'#C8D1EA', font:'600 12px Inter'} }] },
          options: months.map(m=>({ title:{ text:m, left:'center', top:6, textStyle:{ color:'#E6E9F2', fontSize:14, fontWeight:700 } }, yAxis:{ data:(topByMonth[m]||[]).map(d=>d.name) }, series:[{ data:(topByMonth[m]||[]).map(d=>d.value) }] })) };
      }
      function buildZerosOption(months, totals, currentMonth){
        const data = months.map(m => (totals.find(t=>t.month===m)?.value)||0); const idx = months.indexOf(currentMonth);
        return { backgroundColor:'transparent', grid:{ left:56,right:26,top:40,bottom:80, containLabel:true }, xAxis:{ type:'category', data: months, axisLabel:{ color:'#BFC7E5' }, axisTick:{ show:false }, axisLine:{ lineStyle:{ color:'rgba(255,255,255,.25)'} } }, yAxis:{ type:'value', axisLabel:{ color:'#BFC7E5' }, splitLine:{ lineStyle:{ color:'rgba(255,255,255,.08)'} } }, tooltip:{ trigger:'axis', borderColor:'rgba(255,255,255,.15)', backgroundColor:'rgba(9,13,31,.96)', textStyle:{ color:'#E6E9F2' } }, series:[{ name:'Zero results', type:'line', smooth:true, symbol:'circle', symbolSize:6, lineStyle:{ width:3 }, areaStyle:{ opacity:.08 }, itemStyle:{ color:'#FF5630' }, data, markPoint: idx>=0 ? { data:[{ xAxis: idx, yAxis: data[idx], value: data[idx]}] } : undefined }], graphic:[{ type:'text', right:10, top:6, style:{ text:'Zero-result totals', fill:'#C8D1EA', font:'600 12px Inter' } }] };
      }
      function buildTrailsOption(months, series){
        const tuned = (series||[]).map(s=>({
          ...s,
          showSymbol:false,
          symbolSize:4,
          lineStyle:{ width:2 }
        }));
        const names = tuned.map(s=>s.name);
        const pageSize = state.trailsLegendCols * state.trailsLegendRows; // 2 rows per page
        const totalPages = Math.max(1, Math.ceil(names.length / pageSize));
        state.trailsLegendTotalPages = totalPages;
        if(state.trailsLegendPage >= totalPages) state.trailsLegendPage = totalPages - 1;
        const start = state.trailsLegendPage * pageSize;
        const pageData = names.slice(start, start + pageSize);
        const row1 = pageData.slice(0, state.trailsLegendCols);
        const row2 = pageData.slice(state.trailsLegendCols, pageSize);
        return {
          backgroundColor:'transparent',
          grid:{ left:56, right:18, top:78, bottom:64, containLabel:true },
          legend:[
            { top:6, left:56, right:18, data: row1, textStyle:{ color:'#BFC7E5' }, itemGap:18 },
            { top:34, left:56, right:18, data: row2, textStyle:{ color:'#BFC7E5' }, itemGap:18 }
          ],
          tooltip:{ trigger:'axis' },
          xAxis:{ type:'category', data: months, axisLabel:{ color:'#BFC7E5' } },
          yAxis:{ type:'value', axisLabel:{ color:'#BFC7E5', formatter:'{value}%' }, splitLine:{ lineStyle:{ color:'rgba(255,255,255,.08)'} } },
          dataZoom:[ { type:'slider', xAxisIndex:0, height:14, bottom:8 }, { type:'inside', xAxisIndex:0 } ],
          series: tuned
        };
      }
      
      function buildHeatmapOption(months, yCats, matrix){
        const data = [];
        const yIndex = new Map(yCats.map((k,i)=>[k,i]));
        const xIndex = new Map(months.map((m,i)=>[m,i]));
        let vmax = 0;
        for(const row of matrix){ // {month, keyword, value}
          const yi = yIndex.get(row.keyword); const xi = xIndex.get(row.month);
          if(yi==null || xi==null) continue;
          data.push([xi, yi, row.value]); vmax = Math.max(vmax, row.value);
        }
        // Revert to the stable layout that used to work well: fixed left gutter + trimmed labels
        return {
          backgroundColor:'transparent',
          grid:{ left:120, right:70, top:30, bottom:28 },
          tooltip:{ position:'top' },
          xAxis:{ type:'category', data: months, splitArea:{ show:false }, axisLabel:{ color:'#BFC7E5' } },
          yAxis:{ type:'category', data: yCats.map(k=>labelTrim(k, 22)), splitArea:{ show:false }, axisLabel:{ color:'#E6E9F2' } },
          visualMap:{ min:0, max:vmax||1, calculable:true, orient:'vertical', right:10, top:'middle', text:['more','less'] },
          series:[{ name:'Zero results', type:'heatmap', data, emphasis:{ itemStyle:{ shadowBlur:10, shadowColor:'rgba(0,0,0,0.4)' } } }]
        };
      }

      // --- Data transforms for new gadgets ---
      function computeTrailsSeries(sourceRaw, months, topN){
        // Score keywords by total percentage across all months
        const sum = new Map();
        for(const r of sourceRaw){ const k = String(r.keyword||'').trim(); const v = asNumber(r.percentage); if(!Number.isFinite(v)) continue; sum.set(k, (sum.get(k)||0)+v); }
        const top = Array.from(sum.entries()).sort((a,b)=>b[1]-a[1]).slice(0, topN).map(([k])=>k);
        // Build series per keyword across months
        const byMonthKey = new Map();
        for(const r of sourceRaw){ const m = toMonthKey(r.month); const k = String(r.keyword||'').trim(); const v = asNumber(r.percentage); if(!byMonthKey.has(m)) byMonthKey.set(m, new Map()); byMonthKey.get(m).set(k, v); }
        const series = top.map(k=>({ name:k, type:'line', smooth:true, symbol:'circle', symbolSize:5, data: months.map(m=> byMonthKey.get(m)?.get(k) ?? null) }));
        return series;
      }
      function computeHeatmapMatrix(zeroRaw, months, topK){
        // Top K zero-result keywords by total count
        const totals = new Map(); for(const r of zeroRaw){ const k = String(r.keyword||'').trim(); const v = asNumber(r.count); if(!Number.isFinite(v)) continue; totals.set(k, (totals.get(k)||0)+v); }
        const yCats = Array.from(totals.entries()).sort((a,b)=>b[1]-a[1]).slice(0, topK).map(([k])=>k);
        // Matrix rows
        const byMonthKey = new Map(); for(const r of zeroRaw){ const m = toMonthKey(r.month); const k = String(r.keyword||'').trim(); const v = asNumber(r.count); if(!byMonthKey.has(m)) byMonthKey.set(m, new Map()); byMonthKey.get(m).set(k, (byMonthKey.get(m).get(k)||0)+(Number.isFinite(v)?v:0)); }
        const matrix = [];
        for(const m of months){ const row = byMonthKey.get(m)||new Map(); for(const k of yCats){ matrix.push({ month:m, keyword:k, value: row.get(k)||0 }); } }
        return { yCats, matrix };
      }

      // File status updater
      function updateFileStatus(elementId, message){
        const el = document.getElementById(elementId);
        if(el) el.textContent = message;
      }

      // Pager info for Trails legend
      function syncTrailsPager(totalSeries){
        const pageSize = state.trailsLegendCols * state.trailsLegendRows;
        const total = Math.max(1, Math.ceil((totalSeries||0)/pageSize));
        state.trailsLegendTotalPages = total;
        if(state.trailsLegendPage >= total) state.trailsLegendPage = total-1;
        const el = document.getElementById('trailsPageInfo');
        if(el) el.textContent = `${state.trailsLegendPage+1}/${total}`;
      }

      // --- Render pipeline ---
      function updateHeatRangeControls(){
        const months = state.months;
        const start = Math.max(0, Math.min(state.heatStartIdx, months.length-1));
        const end = Math.max(start, Math.min(state.heatEndIdx, months.length-1));
        state.heatStartIdx = start; state.heatEndIdx = end;
        const s = document.getElementById('heatStart');
        const e = document.getElementById('heatEnd');
        const sv = document.getElementById('heatStartVal');
        const ev = document.getElementById('heatEndVal');
        if(months.length){
          s.min = 0; s.max = months.length-1; e.min = 0; e.max = months.length-1;
          s.value = String(start); e.value = String(end);
          sv.textContent = months[start]; ev.textContent = months[end];
        } else {
          s.min = e.min = 0; s.max = e.max = 0; s.value = e.value = 0; sv.textContent = ev.textContent = '–';
        }
      }

      function renderAll(){
        if(!state.sourceRaw.length){ setStatus('waiting for Popular Search Keywords (or demo)'); return; }
        const { months, topByMonth } = groupByMonthTop(state.sourceRaw, 'percentage', state.topN); state.months = months; if(!months.length){ setStatus('no months detected in source'); return; }
        // 1) Race + zeros overview
        safeSetOption('race', buildRaceOption(months, topByMonth));
        let totals = state.zeroTotals.length ? state.zeroTotals : (state.zeroRaw.length ? totalsByMonth(state.zeroRaw,'count') : []);
        safeSetOption('zeros', buildZerosOption(months, totals, months[0]));
        const race = ensureChart('race');
        if(race){ race.off('timelinechanged'); race.on('timelinechanged', (e)=>{ const month = state.months[e.currentIndex]; safeSetOption('zeros', buildZerosOption(state.months, totals, month)); }); }
        // 2) Keyword trails
        const trailSeries = computeTrailsSeries(state.sourceRaw, months, state.trailsN);
        if(trailSeries.length){ safeSetOption('trails', buildTrailsOption(months, trailSeries)); }
        syncTrailsPager(trailSeries.length);
        // 3) Heatmap (zero results) with range
        updateHeatRangeControls();
        if(state.zeroRaw.length){
          const slice = months.slice(state.heatStartIdx, state.heatEndIdx+1);
          const { yCats, matrix } = computeHeatmapMatrix(state.zeroRaw, slice, state.heatTopK);
          if(yCats.length){ safeSetOption('heatmap', buildHeatmapOption(slice, yCats, matrix)); }
        }
        setStatus(`rendered: months=${months.length}, rows=${state.sourceRaw.length}`);
      }

      // Inputs wiring
      $('#topN').addEventListener('input', e=>{ state.topN = +e.target.value; $('#topNVal').textContent = e.target.value; renderAll(); });
      $('#speed').addEventListener('input', e=>{ state.playInterval = +e.target.value; $('#speedVal').textContent = (state.playInterval/1000).toFixed(1)+"s"; renderAll(); });
      $('#trailsN').addEventListener('input', e=>{ state.trailsN = +e.target.value; $('#trailsNVal').textContent = e.target.value; renderAll(); });
      $('#heatTopK').addEventListener('input', e=>{ state.heatTopK = +e.target.value; $('#heatTopKVal').textContent = e.target.value; renderAll(); });
      $('#heatStart').addEventListener('input', e=>{ state.heatStartIdx = +e.target.value; if(state.heatStartIdx>state.heatEndIdx) state.heatEndIdx = state.heatStartIdx; renderAll(); });
      $('#heatEnd').addEventListener('input', e=>{ state.heatEndIdx = +e.target.value; if(state.heatEndIdx<state.heatStartIdx) state.heatStartIdx = state.heatEndIdx; renderAll(); });
      $('#btn-play').addEventListener('click', ()=>{ state.timelinePlaying = !state.timelinePlaying; $('#btn-play').textContent = state.timelinePlaying ? '⏸ Pause' : '▶ Play'; renderAll(); });

      // Legend pager (Trails)
      document.getElementById('trailsPrev').addEventListener('click', ()=>{ if(state.trailsLegendPage>0){ state.trailsLegendPage--; renderAll(); } });
      document.getElementById('trailsNext').addEventListener('click', ()=>{ if(state.trailsLegendPage < state.trailsLegendTotalPages-1){ state.trailsLegendPage++; renderAll(); } });

      // File inputs
      $('#file-source').addEventListener('change', async (e)=>{ 
        const f = e.target.files[0]; 
        if(!f) { updateFileStatus('source-display', 'No file chosen'); return; }
        state.manualSource = true; setStatus('reading Popular Search Keywords…'); 
        updateFileStatus('source-display', `Loading ${f.name}...`);
        try{ 
          const buf = await f.arrayBuffer(); 
          const wb = XLSX.read(buf,{type:'array'}); 
          const rows = XLSX.utils.sheet_to_json(wb.Sheets['Raw'], { defval:null }); 
          state.sourceRaw = rows.map(r=>({ month:r.month, keyword:String(r.keyword||'').trim(), percentage: asNumber(r.percentage) })); 
          setStatus(`loaded Popular: ${state.sourceRaw.length} rows`); 
          updateFileStatus('source-display', `${f.name} (${state.sourceRaw.length} rows)`);
          renderAll(); 
        }catch(err){ console.error(err); setStatus('error reading Popular file'); updateFileStatus('source-display', 'Error loading file'); } 
      });

      $('#file-zero').addEventListener('change', async (e)=>{ 
        const f = e.target.files[0]; 
        if(!f) { updateFileStatus('zero-display', 'No file chosen'); return; }
        state.manualZero = true; setStatus('reading Zero‑Result Keywords…'); 
        updateFileStatus('zero-display', `Loading ${f.name}...`);
        try{ 
          const buf = await f.arrayBuffer(); 
          const wb = XLSX.read(buf,{type:'array'}); 
          if(wb.Sheets['Monthly_Summary']){ 
            const sum = XLSX.utils.sheet_to_json(wb.Sheets['Monthly_Summary'], { defval:null }); 
            state.zeroTotals = sum.map(r=>({ month: toMonthKey(r.month), value: asNumber(r.sum_count||0) })); 
          } 
          const raw = XLSX.utils.sheet_to_json(wb.Sheets['Raw'], { defval:null }); 
          state.zeroRaw = raw.map(r=>({ month:r.month, keyword:String(r.keyword||'').trim(), count: asNumber(r.count||0) })); 
          setStatus(`loaded Zero: raw ${state.zeroRaw.length}, totals ${state.zeroTotals.length}`); 
          updateFileStatus('zero-display', `${f.name} (${state.zeroRaw.length} rows)`);
          renderAll(); 
        }catch(err){ console.error(err); setStatus('error reading Zero file'); updateFileStatus('zero-display', 'Error loading file'); } 
      });

      // --- Default file autoload (for GitHub Pages) ---
      const DEFAULT_SOURCE_CANDIDATES = ['./data/source_search_keywords_marketplace.xlsx','./source_search_keywords_marketplace.xlsx'];
      const DEFAULT_ZERO_CANDIDATES   = ['./data/zero_result_keywords_marketplace.xlsx','./zero_result_keywords_marketplace.xlsx'];

      async function fetchFirst(urls){
        for(const u of urls){
          try{ const res = await fetch(u, {cache:'no-cache'}); if(res.ok){ return await res.arrayBuffer(); } }catch(e){}
        }
        throw new Error('defaults not found');
      }

      async function tryLoadDefaultSource(){
        setStatus('loading default Popular…');
        const buf = await fetchFirst(DEFAULT_SOURCE_CANDIDATES);
        const wb = XLSX.read(buf,{type:'array'});
        const rows = XLSX.utils.sheet_to_json(wb.Sheets['Raw'], { defval:null });
        state.sourceRaw = rows.map(r=>({ month:r.month, keyword:String(r.keyword||'').trim(), percentage: asNumber(r.percentage) }));
        setStatus(`default Popular loaded: ${state.sourceRaw.length} rows`);
        updateFileStatus('source-display', 'Default data file loaded (see README)');
        renderAll();
      }

      async function tryLoadDefaultZero(){
        setStatus('loading default Zero…');
        const buf = await fetchFirst(DEFAULT_ZERO_CANDIDATES);
        const wb = XLSX.read(buf,{type:'array'});
        if(wb.Sheets['Monthly_Summary']){
          const sum = XLSX.utils.sheet_to_json(wb.Sheets['Monthly_Summary'], { defval:null });
          state.zeroTotals = sum.map(r=>({ month: toMonthKey(r.month), value: asNumber(r.sum_count||0) }));
        }
        const raw = XLSX.utils.sheet_to_json(wb.Sheets['Raw'], { defval:null });
        state.zeroRaw = raw.map(r=>({ month:r.month, keyword:String(r.keyword||'').trim(), count: asNumber(r.count||0) }));
        setStatus(`default Zero loaded: raw ${state.zeroRaw.length}, totals ${state.zeroTotals.length}`);
        updateFileStatus('zero-display', 'Default data file loaded (see README)');
        renderAll();
      }

      async function autoLoadDefaults(){
        if(state.defaultsTried) return; state.defaultsTried = true;
        let any = false;
        if(!state.sourceRaw.length && !state.manualSource){ 
          try{ await tryLoadDefaultSource(); any = true; } 
          catch(e){ 
            console.info('No default Popular found'); 
            updateFileStatus('source-display', 'No file chosen');
          } 
        }
        if(!state.zeroRaw.length && !state.manualZero){ 
          try{ await tryLoadDefaultZero(); any = true; } 
          catch(e){ 
            console.info('No default Zero found'); 
            updateFileStatus('zero-display', 'No file chosen');
          } 
        }
        if(!any) setStatus('ready — upload files or Load demo');
      }

      // Demo data & tests
      const demo = { sourceRaw:[
        {month:'2023-08-01', keyword:'scriptrunner', percentage:3.30},
        {month:'2023-08-01', keyword:'jira', percentage:3.03},
        {month:'2023-08-01', keyword:'structure', percentage:2.95},
        {month:'2023-08-01', keyword:'automation', percentage:2.74},
        {month:'2023-08-01', keyword:'portfolio', percentage:2.55},
        {month:'2023-09-01', keyword:'scriptrunner', percentage:3.90},
        {month:'2023-09-01', keyword:'jira', percentage:3.60},
        {month:'2023-09-01', keyword:'automation', percentage:2.80},
        {month:'2023-09-01', keyword:'structure', percentage:2.30},
        {month:'2023-09-01', keyword:'tempo', percentage:2.00},
        {month:'2023-10-01', keyword:'scriptrunner', percentage:3.40},
        {month:'2023-10-01', keyword:'automation', percentage:3.10},
        {month:'2023-10-01', keyword:'jira', percentage:2.70},
        {month:'2023-10-01', keyword:'structure', percentage:2.20},
        {month:'2023-10-01', keyword:'eazybi', percentage:1.80},
        {month:'2023-11-01', keyword:'automation', percentage:3.50},
        {month:'2023-11-01', keyword:'scriptrunner', percentage:3.10},
        {month:'2023-11-01', keyword:'jira', percentage:2.80},
        {month:'2023-11-01', keyword:'tempo', percentage:2.20},
        {month:'2023-11-01', keyword:'structure', percentage:1.90},
        {month:'2023-12-01', keyword:'automation', percentage:3.70},
        {month:'2023-12-01', keyword:'jira', percentage:3.20},
        {month:'2023-12-01', keyword:'scriptrunner', percentage:2.90},
        {month:'2023-12-01', keyword:'structure', percentage:2.10},
        {month:'2023-12-01', keyword:'portfolio', percentage:1.60}
      ], zeroRaw:[
        {month:'2023-08-01', keyword:'cost tracker', count:40},
        {month:'2023-08-01', keyword:'rpa', count:80},
        {month:'2023-09-01', keyword:'rpa', count:120},
        {month:'2023-10-01', keyword:'rpa', count:60},
        {month:'2023-10-01', keyword:'okrs', count:40},
        {month:'2023-12-01', keyword:'okrs', count:200}
      ], zeroTotals:[
        {month:'2023-08', value:1719}, {month:'2023-09', value:1481}, {month:'2023-10', value:554}, {month:'2023-11', value:2}, {month:'2023-12', value:730}
      ] };

      document.getElementById('btn-demo').addEventListener('click', ()=>{
        state.sourceRaw = demo.sourceRaw.slice();
        state.zeroRaw = demo.zeroRaw.slice();
        state.zeroTotals = demo.zeroTotals.slice();
        state.timelinePlaying = true; document.getElementById('btn-play').textContent = '⏸ Pause'; renderAll();
      });

      function runSmokeTests(){
        const out = []; const ok = (name, cond)=>{ out.push(`${cond? '✅':'❌'} ${name}`); if(!cond) console.error('Test failed:', name); };
        ok('race container exists', !!document.getElementById('race'));
        ok('zeros container exists', !!document.getElementById('zeros'));
        ok('trails container exists', !!document.getElementById('trails'));
        ok('heatmap container exists', !!document.getElementById('heatmap'));
        try{ /* empty render */ renderAll(); ok('renderAll without data does not throw', true); }catch(e){ ok('renderAll without data does not throw', false); }
        // Verify wrapLabel inserts a newline for long strings
        const wl = wrapLabel('this is a very very long keyword title that should wrap into two lines', 18);
        ok('wrapLabel inserts newline', wl.includes('\n'));
        // With demo
        state.sourceRaw = demo.sourceRaw.slice(); state.zeroRaw = demo.zeroRaw.slice(); state.zeroTotals = demo.zeroTotals.slice();
        try{ renderAll(); const race = ensureChart('race'); const zeros = ensureChart('zeros'); const trails = ensureChart('trails'); const heat = ensureChart('heatmap'); ok('race chart instance created', !!race); ok('zeros chart instance created', !!zeros); ok('trails chart instance created', !!trails); ok('heatmap chart instance created', !!heat); }catch(e){ ok('render with demo data succeeds', false); }
        // Range controls reflect months length
        const s = document.getElementById('heatStart'); const e = document.getElementById('heatEnd');
        ok('heatStart max set', +s.max === state.months.length-1);
        ok('heatEnd max set', +e.max === state.months.length-1);
        setStatus('Smoke tests results:\n' + out.join('\n'));
      }
      document.getElementById('btn-test').addEventListener('click', runSmokeTests);

      // Make file displays clickable
      document.getElementById('source-display').addEventListener('click', ()=>{ document.getElementById('file-source').click(); });
      document.getElementById('zero-display').addEventListener('click', ()=>{ document.getElementById('file-zero').click(); });

      // Try to autoload defaults on boot (works on GitHub Pages when files are in repo)
      autoLoadDefaults();

      window.addEventListener('resize', ()=>{ state.charts.race?.resize?.(); state.charts.zeros?.resize?.(); state.charts.trails?.resize?.(); state.charts.heatmap?.resize?.(); });
    }
  })();
  </script>
</body>
</html>
