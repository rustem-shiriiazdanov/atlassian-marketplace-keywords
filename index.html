<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Atlassian Marketplace Keywords</title>
  <style>
    :root{ --bg:#0B1021; --card:#121835; --ink:#E6E9F2; --muted:#A9B0C6; --accent:#4C9AFF; --danger:#FF5630; --chip:#1B2348; --radius:16px; --shadow:0 20px 40px rgba(0,0,0,.35);}  
    html,body{height:100%}
    body{margin:0;background:#0B1021;color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1280px;margin:24px auto 64px;padding:0 20px}
    header{display:flex;gap:16px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0 0 6px;font-size:28px;font-weight:700}
    .sub{color:var(--muted);font-size:13px}
    .links{display:flex;gap:12px;align-items:center;font-size:13px}
    .links a{display:flex;align-items:center;gap:6px;color:var(--ink);text-decoration:none;white-space:nowrap}
    .links a:hover{color:var(--accent)}
    .links img,.links svg{height:16px;width:16px}
    .links button{font-size:13px;white-space:nowrap}
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.00));border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow)}
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;padding:14px;background:var(--card);border-radius:var(--radius)}
    .controls.soft{padding:10px;margin-top:8px}
    label{font-size:12px;color:var(--muted)}
    .chip{background:var(--chip);border:1px solid rgba(255,255,255,.06);border-radius:999px;padding:8px 12px;display:flex;gap:8px;align-items:center}
    .file-input-wrapper{position:relative;display:inline-block}
    .file-input-wrapper input[type="file"]{display:none}
    .file-input-display{cursor:pointer;padding:4px 8px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:var(--ink);font-size:11px;display:inline-block;min-width:150px}
    .keyword-select-wrapper{position:relative;display:inline-block}
    .keyword-select-display{cursor:pointer;padding:4px 8px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:var(--ink);font-size:11px;display:inline-block;min-width:150px}
    .keyword-select-dropdown{position:absolute;top:100%;left:0;background:var(--card);border:1px solid rgba(255,255,255,.12);border-radius:6px;padding:6px;margin-top:4px;box-shadow:var(--shadow);max-height:200px;overflow:auto;display:none;z-index:20}
    .keyword-select-dropdown.open{display:block}
    .keyword-select-dropdown label{display:flex;align-items:center;gap:4px;font-size:12px;padding:2px 4px}
    .keyword-select-dropdown label:hover{background:rgba(255,255,255,.05)}
    .keyword-select-dropdown input[type="text"]{width:100%;padding:2px 4px;margin-bottom:4px;border:1px solid rgba(255,255,255,.2);border-radius:4px;background:var(--card);color:var(--ink);font-size:12px}
    .btn{cursor:pointer;border:0;border-radius:10px;padding:8px 12px;font-weight:600;color:#0B1021;background:var(--accent)}
    .btn.ghost{background:transparent;color:var(--ink);border:1px solid rgba(255,255,255,.12)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    .card{padding:12px}
    .card h3{margin:4px 6px 10px;font-size:13px;font-weight:600;color:var(--muted);letter-spacing:.2px}
    .card h3.has-toolbar{display:flex;align-items:center}
    .card h3.has-toolbar .chart-toolbar{position:static;margin-left:auto}
    .chart{height:520px;width:100%;display:flex;align-items:center;justify-content:center;position:relative}
    .chart-toolbar{position:absolute;top:8px;right:8px;display:flex;gap:6px;z-index:10}
    .chart-toolbar .btn{padding:4px 6px;font-size:11px}
    .chart-toolbar .btn svg{width:16px;height:16px}
    .chart.flip{animation:flipY .6s}
    @keyframes flipY{0%{transform:rotateY(0)}50%{transform:rotateY(90deg)}100%{transform:rotateY(0)}}
    .short{height:420px}
    .tall{height:580px}
    .chart .placeholder{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#8EA2E3;font-size:12px;letter-spacing:.2px}
    .status{font-size:12px;color:var(--muted);margin-top:6px;white-space:pre-line}
    input[type="range"]{accent-color:var(--accent)}
    input[type="file"]{color:var(--ink);font-size:12px}
    code.bad{color:var(--danger)}
    .chip.disabled{opacity:.5}
    .chip.disabled input{accent-color:var(--muted);cursor:not-allowed}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .mini-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .mini{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:10px}
    .help{display:inline-flex;align-items:center;justify-content:center;width:14px;height:14px;margin-left:4px;border-radius:50%;background:var(--muted);color:#0B1021;font-size:11px;font-weight:700;cursor:pointer}
    .tooltip{position:absolute;z-index:1000;max-width:220px;background:var(--card);color:var(--ink);border:1px solid rgba(255,255,255,.12);padding:6px 8px;font-size:11px;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,.35);display:none;white-space:pre-wrap}
    @media (max-width:980px){.grid{grid-template-columns:1fr}.chart{height:460px}.short{height:380px}.tall{height:520px}.two-col{grid-template-columns:1fr}.mini-grid{grid-template-columns:1fr}}
    html.mobile .wrap{max-width:100%;margin:12px auto;padding:0 10px}
    html.mobile header{flex-direction:column;align-items:flex-start}
    html.mobile .controls{flex-direction:column;align-items:stretch}
    html.mobile .grid{grid-template-columns:1fr}
    html.mobile .mini-grid{grid-template-columns:1fr}
    html.mobile .chart,html.mobile .short,html.mobile .tall{height:100vh}
    </style>
    <script>
      if(/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)){
        document.documentElement.classList.add('mobile');
      }
    </script>
    <script>
      // Disable native alert-style dialogs that can interrupt workflow
      window.alert = () => {};
      window.confirm = () => true;
      window.prompt = () => null;
    </script>
  </head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Atlassian Marketplace Keywords Charts (excel-sourced)</h1>
        <div class="sub">What’s inside:<br>
        • <strong>Bar Chart Race</strong>: monthly race of top search keywords.<br>
        • <strong>Zero-Result Overview</strong>: trend of searches that returned no results.<br>
        • <strong>Keyword Trails</strong>: top keywords’ percentage trajectories by month.<br>
        • <strong>Zero-Result Heatmap</strong>: where empty (zero-result) searches cluster across months.</div>
        <div id="status" class="status">Status: bootstrapping…</div>
      </div>
      <div class="links">
        <a href="https://github.com/rustem-shiriiazdanov/atlassian-marketplace-keywords" target="_blank" rel="noopener noreferrer">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12z"/></svg>
          GitHub
        </a>
        <a href="https://actonic.de/en/" target="_blank" rel="noopener noreferrer">
          <img src="img/actonic.svg" alt="Actonic logo">
          Powered by Actonic
        </a>
        <button id="btn-share-page" class="btn ghost" aria-label="Share page"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg></button>
      </div>
    </header>

    <section class="grid">
      <!-- PANEL 1: Data inputs & diagnostics -->
      <div class="panel card" style="grid-column:1 / -1;">
        <h3>Data Inputs & Diagnostics <span class="help" data-help="Upload monthly keyword spreadsheets to drive the charts and check for missing data." data-testid="help-inputs">?</span></h3>
        <div class="controls">
          <div class="chip">
            <label>Popular Search Keywords</label><span class="help" data-help="Spreadsheet exported from the Popular Search Keywords API." data-testid="help-source">?</span>
            <div class="file-input-wrapper">
              <input id="file-source" type="file" accept=".xlsx,.xls" />
              <div id="source-display" class="file-input-display">No file chosen</div>
            </div>
          </div>
          <div class="chip">
            <label>Zero‑Result Keywords</label><span class="help" data-help="Spreadsheet of searches that returned no apps." data-testid="help-zero">?</span>
            <div class="file-input-wrapper">
              <input id="file-zero" type="file" accept=".xlsx,.xls" />
              <div id="zero-display" class="file-input-display">No file chosen</div>
            </div>
          </div>
          <div class="chip">
            <label>Keyword Filter</label>
            <div class="keyword-select-wrapper">
              <div id="keywordFilterInput" class="keyword-select-display">All keywords</div>
              <div id="keywordOptions" class="keyword-select-dropdown"></div>
            </div>
            <button id="keywordFilterReset" class="btn ghost" style="padding:4px 6px" aria-label="Reset keyword filter">✕</button>
          </div>
          <button id="btn-load-defaults" class="btn ghost">Load default files</button>
          <button id="btn-demo" class="btn ghost">Load demo</button>
          <button id="btn-test" class="btn ghost">Run smoke tests</button>
        </div>
      </div>

      <!-- PANEL 2: United Race + Zeros with local controls -->
      <div class="panel card" style="grid-column:1 / -1;">
        <h3>Search Dynamics — Bar Chart Race & Zero‑Result Overview <span class="help" data-help="Track how popular search terms and zero-result totals change to guide product and marketing focus." data-testid="help-dynamics">?</span></h3>
        <div class="mini-grid">
          <!-- mini: shared controls -->
          <div class="mini" style="grid-column:1 / -1;">
            <div class="controls soft">
              <div class="chip">
                <label>Top&nbsp;N</label><span class="help" data-help="Number of top keywords per month shown in the race." data-testid="help-topn">?</span>
                <input id="topN" type="range" min="5" max="20" value="10" />
                <span id="topNVal">10</span>
              </div>
              <div class="chip">
                <label>Speed</label><span class="help" data-help="Animation speed of the race in milliseconds." data-testid="help-speed">?</span>
                <input id="speed" type="range" min="300" max="3000" value="1200" step="100" />
                <span id="speedVal">1.2s</span>
              </div>
              <button id="btn-play" class="btn">▶ Play</button>
            </div>
          </div>
          <!-- mini: bar race -->
          <div class="mini">
            <div id="race" class="chart" data-testid="race"><div class="placeholder">Loading ECharts…</div></div>
            <div class="status">The chart plays the appearances of top popular keywords each month.</div>
          </div>
          <!-- mini: zero totals -->
          <div class="mini">
            <div id="zeros" class="chart" data-testid="zeros"><div class="placeholder">Loading ECharts…</div></div>
            <div class="status">The number of times people were seeking some keywords but ended up with zero search results (they found nothing!).</div>
          </div>
        </div>
      </div>

      <!-- PANEL 3: Trails with local control -->
      <div class="panel card" style="grid-row: span 2;">
        <h3>Keyword Trails — Popular Keywords Over Time <span class="help" data-help="Follow individual keyword popularity to monitor long‑term trends." data-testid="help-trails">?</span></h3>
        <div class="controls soft">
          <div class="chip">
            <label>Trails</label><span class="help" data-help="Number of keyword lines to plot." data-testid="help-trailsN">?</span>
              <input id="trailsN" type="range" min="3" max="12" value="6" />
              <span id="trailsNVal">6</span>
            </div>
            <div class="chip">
              <span class="help" data-help="Cycle through legend pages (two rows per page)." data-testid="help-trailsLegend">?</span>
              <button id="trailsPrev" class="btn ghost" style="padding:6px 8px">◀</button>
              <span id="trailsPageInfo">1/1</span>
            <button id="trailsNext" class="btn ghost" style="padding:6px 8px">▶</button>
          </div>
        </div>
        <div id="trails" class="chart tall" data-testid="trails"><div class="placeholder">Awaiting data…</div></div>
        <div class="status">This chart shows the top N keywords overall with their <code>percentage</code> trajectory by month.</div>
      </div>

      <!-- PANEL 4: Heatmap with local controls -->
      <div class="panel card" style="grid-row: span 2;">
        <h3>Zero‑Result Heatmap — Where Users Find Nothing <span class="help" data-help="Locate content gaps by spotting keywords that consistently return no apps." data-testid="help-heatmap">?</span></h3>
        <div class="controls soft">
          <div class="chip">
            <label>Heatmap&nbsp;TopK</label><span class="help" data-help="Number of zero-result keywords to show." data-testid="help-heatTopK">?</span>
              <input id="heatTopK" type="range" min="8" max="30" value="15" />
              <span id="heatTopKVal">15</span>
            </div>
            <div class="chip" id="heatTimeRangeChip">
              <label>Time&nbsp;Range</label><span class="help" data-help="Select month range to rank zero-result keywords." data-testid="help-heatRange">?</span>
              <input id="heatTimeStart" type="range" min="1" max="1" value="1" />
              <span id="heatTimeStartVal">1</span>
            <input id="heatTimeEnd" type="range" min="1" max="1" value="1" />
            <span id="heatTimeEndVal">1</span>
          </div>
        </div>
        <div id="heatmap" class="chart" data-testid="heatmap"><div class="placeholder">Awaiting data…</div></div>
        <div class="status">This chart shows the top K zero-result keywords by total count across months, where darker means more empty (zero-result) searches.</div>
      </div>
    </section>
  </div>

  <script>
  // --- Robust sequential loader with fallbacks ---
  (function(){
    const statusEl = document.getElementById('status');
    const setStatus = (t)=>{ if(statusEl) statusEl.textContent = 'Status: ' + t; };

    function loadScriptSeq(urls, globalName){
      return new Promise((resolve, reject)=>{
        let i = 0;
        const tryNext = ()=>{
          if(i >= urls.length){ reject(new Error('All CDNs failed for '+globalName)); return; }
          const url = urls[i++];
          setStatus(`loading ${globalName} from ${new URL(url).hostname}…`);
          const s = document.createElement('script');
          s.src = url; s.async = true; s.crossOrigin = 'anonymous'; s.referrerPolicy = 'no-referrer';
          s.onload = ()=>{ setTimeout(()=>{ if(window[globalName]){ setStatus(`${globalName} loaded from ${new URL(url).hostname}`); resolve(window[globalName]); } else { tryNext(); } }, 0); };
          s.onerror = ()=>{ setStatus(`${globalName} failed from ${new URL(url).hostname}, trying next…`); tryNext(); };
          document.head.appendChild(s);
        };
        tryNext();
      });
    }

    const ECHARTS_URLS = [
      'https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js',
      'https://unpkg.com/echarts@5.5.0/dist/echarts.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/echarts/5.3.3/echarts.min.js'
    ];
    const XLSX_URLS = [
      'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
      'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js'
    ];

    function boot(){
      Promise.all([
        window.echarts ? Promise.resolve(window.echarts) : loadScriptSeq(ECHARTS_URLS, 'echarts'),
        window.XLSX ? Promise.resolve(window.XLSX) : loadScriptSeq(XLSX_URLS, 'XLSX')
      ]).then(()=>{
        setStatus('libraries ready');
        startApp();
      }).catch(err=>{
        console.error(err);
        setStatus('error: '+ err.message);
      });
    }

    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', boot);
    } else { boot(); }

    // --- App starts only after libs are ready ---
    function startApp(){
      const $ = (sel)=>document.querySelector(sel);
      const setStatus = (t)=> $('#status').textContent = `Status: ${t}`;

      function initHelp(){
        const tip = document.createElement('div');
        tip.className = 'tooltip';
        document.body.appendChild(tip);
        const show = (e)=>{
          const msg = e.currentTarget.getAttribute('data-help') || e.currentTarget.getAttribute('title');
          if(!msg) return;
          tip.textContent = msg;
          const r = e.currentTarget.getBoundingClientRect();
          tip.style.left = (r.left + window.scrollX) + 'px';
          tip.style.top = (r.bottom + window.scrollY + 6) + 'px';
          tip.style.display = 'block';
        };
        const hide = ()=>{ tip.style.display = 'none'; };
        document.querySelectorAll('.help').forEach(el=>{
          el.addEventListener('mouseenter', show);
          el.addEventListener('mouseleave', hide);
          el.addEventListener('touchstart', show);
          el.addEventListener('touchend', hide);
        });
      }

    const state = {
        charts: { race: null, zeros: null, trails: null, heatmap: null },
        sourceRaw: [], zeroRaw: [], zeroTotals: [],
        months: [],
        zeroMode: 'totals',
        topN: 10, playInterval: 1200, timelinePlaying: false,
        trailsN: 6, heatTopK: 15,
        keywordFilter: [],
        heatTimeStartIdx: 0, heatTimeEndIdx: 0, heatTimeRangeInitialized: false, trailsLegendPage: 0, trailsLegendCols: 3, trailsLegendRows: 2, trailsLegendTotalPages: 1,
        // default data autoload flags
        manualSource: false, manualZero: false, defaultsTried: false
      };

      const ICON_DOWNLOAD = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>`;
      const ICON_SHARE = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>`;
      const ICON_FLIP = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>`;

      // --- Utils ---
      function sanitizeKeyword(k){
        return String(k||'').replace(/[<>]/g,'').trim();
      }
      function updateKeywordDisplay(){
        const disp = document.getElementById('keywordFilterInput');
        if(disp) disp.textContent = state.keywordFilter.length ? state.keywordFilter.join(', ') : 'All keywords';
      }
      function populateKeywordOptions(){
        const set = new Set();
        for(const r of state.sourceRaw){ const k = sanitizeKeyword(r.keyword); if(k) set.add(k); }
        for(const r of state.zeroRaw){ const k = sanitizeKeyword(r.keyword); if(k) set.add(k); }
        const list = document.getElementById('keywordOptions');
        if(list){
          const wasOpen = list.classList.contains('open');
          const prevSearch = list.querySelector('#keywordSearch')?.value.toLowerCase() || '';
          list.innerHTML = '';
          const search = document.createElement('input');
          search.type = 'text';
          search.id = 'keywordSearch';
          search.placeholder = 'Search keywords…';
          search.value = prevSearch;
          list.appendChild(search);
          const box = document.createElement('div');
          box.id = 'keywordCheckboxes';
          list.appendChild(box);
          const keywords = Array.from(set).sort();
          for(const k of keywords){
            const label = document.createElement('label');
            const cb = document.createElement('input'); cb.type = 'checkbox'; cb.value = k;
            cb.checked = state.keywordFilter.includes(k);
            label.appendChild(cb);
            label.appendChild(document.createTextNode(' '+k));
            box.appendChild(label);
            cb.addEventListener('change', ()=>{
              if(cb.checked){
                if(!state.keywordFilter.includes(cb.value)) state.keywordFilter.push(cb.value);
              } else {
                state.keywordFilter = state.keywordFilter.filter(x=>x!==cb.value);
              }
              updateKeywordDisplay();
              renderAll();
            });
          }
          const applyFilter = (q)=>{
            for(const label of box.querySelectorAll('label')){
              const txt = label.textContent.toLowerCase();
              label.style.display = txt.includes(q) ? '' : 'none';
            }
          };
          search.addEventListener('input', ()=> applyFilter(search.value.toLowerCase()));
          search.addEventListener('keydown', e=>{
            if(e.key === 'Enter'){
              const val = search.value;
              const cb = Array.from(box.querySelectorAll('input[type="checkbox"]')).find(i=>i.value===val);
              if(cb){
                cb.checked = true;
                cb.dispatchEvent(new Event('change'));
              }
              search.value = '';
              applyFilter('');
              e.preventDefault();
            }
          });
          if(prevSearch){
            applyFilter(prevSearch);
            if(wasOpen){
              search.focus();
              const len = search.value.length;
              search.setSelectionRange(len, len);
            }
          }
          if(wasOpen) list.classList.add('open');
        }
        updateKeywordDisplay();
      }
      function toggleRangeSelectors(){
        const disabled = state.keywordFilter.length > 0;
        ['topN','trailsN','heatTopK'].forEach(id=>{
          const el = document.getElementById(id);
          if(el){
            el.disabled = disabled;
            const chip = el.closest('.chip');
            if(chip) chip.classList.toggle('disabled', disabled);
          }
        });
      }
      const toMonthKey = (v)=>{
        try{
          if(typeof v === 'number' && window.XLSX && XLSX.SSF){ const d = XLSX.SSF.parse_date_code(v); const date = new Date(Date.UTC(d.y, d.m-1, d.d)); return date.toISOString().slice(0,7); }
          const d = new Date(v); if(!isNaN(d)) return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), 1)).toISOString().slice(0,7);
          return String(v).trim().slice(0,7);
        }catch(e){ return String(v).trim().slice(0,7); }
      };
      const asNumber = (x)=>{ if(x==null) return NaN; const n = Number(String(x).replace(',','.')); return Number.isFinite(n)?n:NaN; };
      const labelTrim = (s, max=18)=>{ s = String(s||''); return s.length>max ? s.slice(0, max-1) + '…' : s; };
      // Wrap to two lines at a sensible point (space if possible), keep start visible
      function wrapLabel(s, max=22){
        s = String(s||'');
        if(s.length <= max) return s;
        const cut = (str, m)=>{
          if(str.length <= m) return [str, ''];
          let i = str.lastIndexOf(' ', m);
          if(i < Math.floor(m*0.6)) i = str.indexOf(' ', m);
          if(i === -1) i = m;
          return [str.slice(0, i), str.slice(i+1)];
        };
        let [l1, rest] = cut(s, max);
        if(rest.length > max){ rest = rest.slice(0, max-1) + '…'; }
        return l1 + '\n' + rest;
      }

      // Measure text width to size axis gutters dynamically
      const measureTextWidth = (() => {
        const c = document.createElement('canvas');
        const ctx = c.getContext('2d');
        ctx.font = '12px Inter';
        return (s)=> ctx.measureText(String(s||'')).width;
      })();

      const trimToWidth = (s, maxPx)=>{
        s = String(s||'');
        if(measureTextWidth(s) <= maxPx) return s;
        while(s.length && measureTextWidth(s + '…') > maxPx){
          s = s.slice(0, -1);
        }
        return s + '…';
      };

      function chartBg(chart){
        let el = chart.getDom();
        while(el && el !== document.body){
          const bg = getComputedStyle(el).backgroundColor;
          if(bg && bg !== 'rgba(0, 0, 0, 0)' && bg !== 'transparent') return bg;
          el = el.parentElement;
        }
        return getComputedStyle(document.body).backgroundColor || '#ffffff';
      }

      function downloadChartPng(chart, filename='chart.png'){
        const bg = chartBg(chart);
        const dataURL = chart.getDataURL({type:'png', pixelRatio: window.devicePixelRatio||2, backgroundColor: bg});
        const a = document.createElement('a');
        a.href = dataURL;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      async function shareChart(chart, {title, text, permalink, filename='chart.png'}){
        const bg = chartBg(chart);
        const dataURL = chart.getDataURL({type:'png', pixelRatio:2, backgroundColor: bg});
        if(navigator.share){
          try{
            const res = await fetch(dataURL);
            const blob = await res.blob();
            const file = new File([blob], filename, {type:'image/png'});
            if(navigator.canShare && navigator.canShare({files:[file]})){
              await navigator.share({title, text, url:permalink, files:[file]});
              return;
            }
            await navigator.share({title, text, url:permalink});
            return;
          }catch(e){ /* continue to fallback */ }
        }
        openShareChooser({url:permalink, text});
      }

      function openShareChooser({url, text}){
        const u = encodeURIComponent(url);
        const t = encodeURIComponent(text||'');
        const options = [
          {label:'X (Twitter)', href:`https://twitter.com/intent/tweet?url=${u}&text=${t}`},
          {label:'LinkedIn', href:`https://www.linkedin.com/sharing/share-offsite/?url=${u}`},
          {label:'Facebook', href:`https://www.facebook.com/sharer/sharer.php?u=${u}`},
          {label:'Reddit', href:`https://www.reddit.com/submit?url=${u}&title=${t}`},
          {label:'Telegram', href:`https://t.me/share/url?url=${u}&text=${t}`},
          {label:'WhatsApp', href:`https://api.whatsapp.com/send?text=${t}%20${u}`},
          {label:'Email', href:`mailto:?subject=${t}&body=${t}%0A%0A${u}`}
        ];
        let overlay = document.getElementById('shareOverlay');
        if(!overlay){
          overlay = document.createElement('div');
          overlay.id = 'shareOverlay';
          overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:10000;';
          const box = document.createElement('div');
          box.style.cssText = 'background:var(--card);padding:16px;border-radius:8px;color:var(--ink);max-width:320px;width:90%;';
          box.innerHTML = `<h3 style="margin-top:0;">Share</h3><ul style="line-height:1.9;padding-left:20px;margin:0 0 12px;"></ul><input style="width:100%;margin-bottom:12px;" readonly><button class="btn" style="width:100%">Close</button>`;
          overlay.appendChild(box);
          box.querySelector('button').addEventListener('click', ()=> overlay.style.display='none');
          overlay.addEventListener('click', e=>{ if(e.target===overlay) overlay.style.display='none'; });
          document.body.appendChild(overlay);
        }
        const list = overlay.querySelector('ul');
        list.innerHTML = options.map(o=>`<li><a href="${o.href}" target="_blank" rel="noopener">${o.label}</a></li>`).join('');
        overlay.querySelector('input').value = url;
        overlay.style.display = 'flex';
      }

      function sharePage(){
        const permalink = location.href;
        const title = document.title;
        const text = 'Atlassian Marketplace Keywords — interactive charts';
        if(navigator.share){
          navigator.share({title, text, url:permalink}).catch(()=>{});
        }else{
          openShareChooser({url:permalink, text});
        }
      }

      function attachChartToolbar(chartEl, chart, name){
        const makeToolbar = () => {
          const tb = document.createElement('div');
          tb.className = 'chart-toolbar';
          const btns = [];
          if(name === 'zeros') btns.push(`<button class="btn ghost" data-action="flip" aria-label="Flip chart">${ICON_FLIP}</button>`);
          btns.push(`<button class="btn ghost" data-action="download" aria-label="Download chart">${ICON_DOWNLOAD}</button>`);
          btns.push(`<button class="btn ghost" data-action="share" aria-label="Share chart">${ICON_SHARE}</button>`);
          tb.innerHTML = btns.join('');
          tb.addEventListener('click', (e)=>{
            const btn = e.target.closest('button'); if(!btn) return;
            const action = btn.dataset.action;
            const permalink = location.href.split('#')[0] + '#' + name;
            if(action === 'download'){
              downloadChartPng(chart, name + '.png');
            } else if(action === 'share'){
              shareChart(chart, {title: `${document.title} — ${name}`, text: `View the ${name} chart`, permalink, filename: name + '.png'});
            } else if(action === 'flip'){
              flipZeros();
            }
          });
          return tb;
        };

        if(name === 'trails' || name === 'heatmap'){
          const panel = chartEl.closest('.panel');
          const title = panel?.querySelector('h3');
          if(title){
            if(title.querySelector('.chart-toolbar')) return;
            title.classList.add('has-toolbar');
            title.appendChild(makeToolbar());
            return;
          }
        }
        if(chartEl.querySelector('.chart-toolbar')) return;
        chartEl.appendChild(makeToolbar());
      }

      function ensureChart(id){
        const el = document.getElementById(id);
        if(!el){ console.error(`#${id} not found`); return null; }
        const ph = el.querySelector('.placeholder'); if(ph) ph.remove();
        if(state.charts[id] && !state.charts[id].isDisposed?.()) return state.charts[id];
        try{ const c = echarts.init(el); state.charts[id] = c; attachChartToolbar(el, c, id); return c; }catch(err){ console.error('echarts.init failed', id, err); return null; }
      }
      function safeSetOption(id, option){ const c = ensureChart(id); if(!c){ setStatus(`error: chart #${id} not ready`); return; } c.setOption(option, true); }

      function flipZeros(){
        const el = document.getElementById('zeros');
        if(!el) return;
        el.classList.add('flip');
        setTimeout(()=>{ state.zeroMode = state.zeroMode === 'totals' ? 'keywords' : 'totals'; renderAll(); },300);
        setTimeout(()=>{ el.classList.remove('flip'); },600);
      }

      // Grouping helpers
      function groupByMonthTop(list, valueField, topN, filter){
        const filt = filter && filter.length ? new Set(filter) : null;
        const by = new Map(); for(const r of list){ const m = toMonthKey(r.month); if(!by.has(m)) by.set(m, []); by.get(m).push(r); }
        const months = Array.from(by.keys()).sort(); const top = {};
        for(const m of months){
          let arr = by.get(m).filter(x=>Number.isFinite(asNumber(x[valueField])));
          if(filt) arr = arr.filter(x=>filt.has(String(x.keyword||'').trim()));
          arr = arr.sort((a,b)=> asNumber(b[valueField]) - asNumber(a[valueField]));
          const sliceCount = filt ? arr.length : topN;
          top[m] = arr.slice(0, sliceCount).map(x=>({ name:String(x.keyword||'').trim(), value:asNumber(x[valueField]) }));
        }
        return { months, topByMonth: top };
      }
      function totalsByMonth(list, valueField, filter){
        const acc = new Map();
        const filt = filter && filter.length ? new Set(filter) : null;
        for(const r of list){ const k = String(r.keyword||'').trim(); if(filt && !filt.has(k)) continue; const m = toMonthKey(r.month); acc.set(m,(acc.get(m)||0)+(asNumber(r[valueField])||0)); }
        return Array.from(acc.entries()).sort((a,b)=>a[0].localeCompare(b[0])).map(([m,v])=>({month:m,value:v}));
      }

      // --- Chart options ---
      function buildRaceOption(months, topByMonth){
        return { backgroundColor:'transparent', animationDurationUpdate: state.playInterval*0.9, animationEasing:'quarticOut',
          timeline:{ axisType:'category', autoPlay: state.timelinePlaying, playInterval: state.playInterval, data: months, label:{ color:'#C8D1EA' }, lineStyle:{ color:'rgba(255,255,255,.35)' }, controlStyle:{ color:'#fff', borderColor:'rgba(255,255,255,.2)' }, bottom: 0 },
          baseOption:{ grid:{ left:8, right:36, top:40, bottom:90, containLabel:true }, xAxis:{ type:'value', splitLine:{ lineStyle:{ color:'rgba(255,255,255,.08)'} }, axisLabel:{ color:'#BFC7E5', formatter:'{value}%'} }, yAxis:{ type:'category', inverse:true, axisLabel:{ color:'#E6E9F2', margin:6, formatter:(val)=>labelTrim(val, 18) }, axisTick:{ show:false }, axisLine:{ show:false } }, tooltip:{ trigger:'item', borderColor:'rgba(255,255,255,.15)', backgroundColor:'rgba(9,13,31,.96)', textStyle:{ color:'#E6E9F2' }, formatter:p=>`<div><b>${p.name}</b><br/>${p.value} %</div>` }, series:[{ type:'bar', realtimeSort:true, barCategoryGap:'20%', label:{ show:true, position:'right', color:'#E6E9F2', formatter:p=>`${p.value.toFixed(2)}%` }, itemStyle:{ borderRadius:[4,12,12,4], color:(p)=> ['#4C9AFF','#36B37E','#6554C0','#FFAB00','#FF5630','#5E5CE6','#00C7E6','#36B37E','#C0B6F2','#79F2C0'][p.dataIndex%10] } }], graphic:[{ type:'text', left:10, top:6, style:{ text:'Popular Keywords', fill:'#C8D1EA', font:'600 12px Inter'} }] },
          options: months.map(m=>({ title:{ text:m, left:'center', top:6, textStyle:{ color:'#E6E9F2', fontSize:14, fontWeight:700 } }, yAxis:{ data:(topByMonth[m]||[]).map(d=>d.name) }, series:[{ data:(topByMonth[m]||[]).map(d=>d.value) }] })) };
      }

      function buildZeroRaceOption(months, topByMonth){
        return { backgroundColor:'transparent', animationDurationUpdate: state.playInterval*0.9, animationEasing:'quarticOut',
          timeline:{ axisType:'category', autoPlay: state.timelinePlaying, playInterval: state.playInterval, data: months, label:{ color:'#C8D1EA' }, lineStyle:{ color:'rgba(255,255,255,.35)' }, controlStyle:{ color:'#fff', borderColor:'rgba(255,255,255,.2)' }, bottom: 0 },
          baseOption:{ grid:{ left:8, right:36, top:40, bottom:90, containLabel:true }, xAxis:{ type:'value', splitLine:{ lineStyle:{ color:'rgba(255,255,255,.08)'} }, axisLabel:{ color:'#BFC7E5' } }, yAxis:{ type:'category', inverse:true, axisLabel:{ color:'#E6E9F2', margin:6, formatter:(val)=>labelTrim(val, 18) }, axisTick:{ show:false }, axisLine:{ show:false } }, tooltip:{ trigger:'item', borderColor:'rgba(255,255,255,.15)', backgroundColor:'rgba(9,13,31,.96)', textStyle:{ color:'#E6E9F2' }, formatter:p=>`<div><b>${p.name}</b><br/>${p.value}</div>` }, series:[{ type:'bar', realtimeSort:true, barCategoryGap:'20%', label:{ show:true, position:'right', color:'#E6E9F2', formatter:p=>p.value }, itemStyle:{ borderRadius:[4,12,12,4], color:(p)=> ['#4C9AFF','#36B37E','#6554C0','#FFAB00','#FF5630','#5E5CE6','#00C7E6','#36B37E','#C0B6F2','#79F2C0'][p.dataIndex%10] } }], graphic:[{ type:'text', left:10, top:6, style:{ text:'Zero-result Keywords', fill:'#C8D1EA', font:'600 12px Inter'} }] },
          options: months.map(m=>({ title:{ text:m, left:'center', top:6, textStyle:{ color:'#E6E9F2', fontSize:14, fontWeight:700 } }, yAxis:{ data:(topByMonth[m]||[]).map(d=>d.name) }, series:[{ data:(topByMonth[m]||[]).map(d=>d.value) }] })) };
      }
      function buildZerosOption(months, totals, currentMonth){
        const data = months.map(m => (totals.find(t=>t.month===m)?.value)||0); const idx = months.indexOf(currentMonth);
        return { backgroundColor:'transparent', grid:{ left:56,right:26,top:40,bottom:80, containLabel:true }, xAxis:{ type:'category', data: months, axisLabel:{ color:'#BFC7E5' }, axisTick:{ show:false }, axisLine:{ lineStyle:{ color:'rgba(255,255,255,.25)'} } }, yAxis:{ type:'value', axisLabel:{ color:'#BFC7E5' }, splitLine:{ lineStyle:{ color:'rgba(255,255,255,.08)'} } }, tooltip:{ trigger:'axis', borderColor:'rgba(255,255,255,.15)', backgroundColor:'rgba(9,13,31,.96)', textStyle:{ color:'#E6E9F2' } }, series:[{ name:'Zero results', type:'line', smooth:true, symbol:'circle', symbolSize:6, lineStyle:{ width:3 }, areaStyle:{ opacity:.08 }, itemStyle:{ color:'#FF5630' }, data, markPoint: idx>=0 ? { data:[{ xAxis: idx, yAxis: data[idx], value: data[idx]}] } : undefined }], graphic:[{ type:'text', left:10, top:6, style:{ text:'Zero-result totals', fill:'#C8D1EA', font:'600 12px Inter' } }] };
      }
      function buildTrailsOption(months, series){
        const tuned = (series||[]).map(s=>({
          ...s,
          showSymbol:false,
          symbolSize:4,
          lineStyle:{ width:2 }
        }));
        const names = tuned.map(s=>s.name);
        const pageSize = state.trailsLegendCols * state.trailsLegendRows; // 2 rows per page
        const totalPages = Math.max(1, Math.ceil(names.length / pageSize));
        state.trailsLegendTotalPages = totalPages;
        if(state.trailsLegendPage >= totalPages) state.trailsLegendPage = totalPages - 1;
        const start = state.trailsLegendPage * pageSize;
        const pageData = names.slice(start, start + pageSize);
        const row1 = pageData.slice(0, state.trailsLegendCols);
        const row2 = pageData.slice(state.trailsLegendCols, pageSize);
        return {
          backgroundColor:'transparent',
          grid:{ left:56, right:18, top:78, bottom:64, containLabel:true },
          legend:[
            { top:6, left:56, right:18, data: row1, textStyle:{ color:'#BFC7E5' }, itemGap:18 },
            { top:34, left:56, right:18, data: row2, textStyle:{ color:'#BFC7E5' }, itemGap:18 }
          ],
          tooltip:{ trigger:'axis' },
          xAxis:{ type:'category', data: months, axisLabel:{ color:'#BFC7E5' } },
          yAxis:{ type:'value', axisLabel:{ color:'#BFC7E5', formatter:'{value}%' }, splitLine:{ lineStyle:{ color:'rgba(255,255,255,.08)'} } },
          dataZoom:[ { type:'slider', xAxisIndex:0, height:14, bottom:8 }, { type:'inside', xAxisIndex:0 } ],
          series: tuned
        };
      }
      
      function buildHeatmapOption(months, yCats, matrix){
        const LABEL_PX = 100;
        const info = yCats.map(k=>{
          const width = measureTextWidth(k);
          return { full: k, short: width > LABEL_PX ? trimToWidth(k, LABEL_PX) : k, width };
        });
        console.debug('heatmap label widths', { maxLabelWidth: LABEL_PX, labels: info });
        const trimmed = info.map(i=>i.short);
        const data = [];
        const yIndex = new Map(yCats.map((k,i)=>[k,i]));
        const xIndex = new Map(months.map((m,i)=>[m,i]));
        let vmax = 0;
        for(const row of matrix){ // {month, keyword, value}
          const yi = yIndex.get(row.keyword); const xi = xIndex.get(row.month);
          if(yi==null || xi==null) continue;
          data.push([xi, yi, row.value]); vmax = Math.max(vmax, row.value);
        }
        return {
          backgroundColor:'transparent',
          grid:{ left:120, right:70, top:30, bottom:64 },
          tooltip:{ position:'top', formatter:(p)=>{
            const kw = yCats[p.value[1]]; const m = months[p.value[0]];
            return `<div><b>${kw}</b><br/>${m}: ${p.value[2]}</div>`;
          } },
          xAxis:{ type:'category', data: months, splitArea:{ show:false }, axisLabel:{ color:'#BFC7E5' } },
          yAxis:{ type:'category', data: trimmed, splitArea:{ show:false }, axisLabel:{ color:'#E6E9F2' } },
          dataZoom:[ { type:'slider', xAxisIndex:0, height:14, bottom:8 }, { type:'inside', xAxisIndex:0 } ],
          visualMap:{ min:0, max:vmax||1, calculable:true, orient:'vertical', right:10, top:'middle', text:['more','less'] },
          series:[{ name:'Zero results', type:'heatmap', data, emphasis:{ itemStyle:{ shadowBlur:10, shadowColor:'rgba(0,0,0,0.4)' } } }]
        };
      }

      // --- Data transforms for new gadgets ---
      function computeTrailsSeries(sourceRaw, months, topN, filter){
        // Score keywords by total percentage across all months
        const sum = new Map();
        const filt = filter && filter.length ? new Set(filter) : null;
        for(const r of sourceRaw){ const k = String(r.keyword||'').trim(); if(filt && !filt.has(k)) continue; const v = asNumber(r.percentage); if(!Number.isFinite(v)) continue; sum.set(k, (sum.get(k)||0)+v); }
        let top = [];
        if(filt){ top = Array.from(filt).filter(k=>sum.has(k)); }
        else { top = Array.from(sum.entries()).sort((a,b)=>b[1]-a[1]).slice(0, topN).map(([k])=>k); }
        // Build series per keyword across months
        const byMonthKey = new Map();
        for(const r of sourceRaw){ const m = toMonthKey(r.month); const k = String(r.keyword||'').trim(); const v = asNumber(r.percentage); if(!byMonthKey.has(m)) byMonthKey.set(m, new Map()); byMonthKey.get(m).set(k, v); }
        const series = top.map(k=>({ name:k, type:'line', smooth:true, symbol:'circle', symbolSize:5, data: months.map(m=> byMonthKey.get(m)?.get(k) ?? null) }));
        return series;
      }
      function computeHeatmapMatrix(zeroRaw, months, topK, startIdx, endIdx, filter){
        const rangeMonths = months.slice(startIdx, endIdx + 1);
        const rangeSet = new Set(rangeMonths);
        const filt = filter && filter.length ? new Set(filter) : null;
        // Top K zero-result keywords within selected months
        const totals = new Map();
        for (const r of zeroRaw) {
          const m = toMonthKey(r.month);
          if (!rangeSet.has(m)) continue;
          const k = String(r.keyword || '').trim();
          if(filt && !filt.has(k)) continue;
          const v = asNumber(r.count);
          if (!Number.isFinite(v)) continue;
          totals.set(k, (totals.get(k) || 0) + v);
        }
        const sorted = Array.from(totals.entries()).sort((a, b) => b[1] - a[1]);
        const yCats = filt ? sorted.map(([k])=>k) : sorted.slice(0, topK).map(([k])=>k);
        // Matrix rows
        const byMonthKey = new Map();
        for (const r of zeroRaw) {
          const m = toMonthKey(r.month);
          const k = String(r.keyword || '').trim();
          if(filt && !filt.has(k)) continue;
          const v = asNumber(r.count);
          if (!byMonthKey.has(m)) byMonthKey.set(m, new Map());
          byMonthKey.get(m).set(k, (byMonthKey.get(m).get(k) || 0) + (Number.isFinite(v) ? v : 0));
        }
        const matrix = [];
        for (const m of months) {
          const row = byMonthKey.get(m) || new Map();
          for (const k of yCats) {
            matrix.push({ month: m, keyword: k, value: row.get(k) || 0 });
          }
        }
        return { yCats, matrix };
      }

      // File status updater
      function updateFileStatus(elementId, message){
        const el = document.getElementById(elementId);
        if(el) el.textContent = message;
      }

      // Pager info for Trails legend
      function syncTrailsPager(totalSeries){
        const pageSize = state.trailsLegendCols * state.trailsLegendRows;
        const total = Math.max(1, Math.ceil((totalSeries||0)/pageSize));
        state.trailsLegendTotalPages = total;
        if(state.trailsLegendPage >= total) state.trailsLegendPage = total-1;
        const el = document.getElementById('trailsPageInfo');
        if(el) el.textContent = `${state.trailsLegendPage+1}/${total}`;
      }

      // --- Render pipeline ---
      function updateHeatTimeRangeControls(){
        const max = state.months.length;

        // Initialize end index to maximum on first load
        if(!state.heatTimeRangeInitialized && max > 0) {
          state.heatTimeEndIdx = max - 1;
          state.heatTimeRangeInitialized = true;
        }

        const start = Math.max(0, Math.min(state.heatTimeStartIdx, max-1));
        const end = Math.max(start, Math.min(state.heatTimeEndIdx, max-1));
        state.heatTimeStartIdx = start; state.heatTimeEndIdx = end;

        const s = document.getElementById('heatTimeStart');
        const e = document.getElementById('heatTimeEnd');
        const sv = document.getElementById('heatTimeStartVal');
        const ev = document.getElementById('heatTimeEndVal');

        if(max){
          s.min = 1; s.max = max; e.min = 1; e.max = max;
          s.value = String(start + 1); e.value = String(end + 1);
          sv.textContent = state.months[start] || '–';
          ev.textContent = state.months[end] || '–';
        } else {
          s.min = e.min = 1; s.max = e.max = 1; s.value = e.value = 1;
          sv.textContent = ev.textContent = '–';
        }
      }

      function renderAll(){
        populateKeywordOptions();
        toggleRangeSelectors();
        if(!state.sourceRaw.length){ setStatus('waiting for Popular Search Keywords (or demo)'); return; }
        const { months, topByMonth } = groupByMonthTop(state.sourceRaw, 'percentage', state.topN, state.keywordFilter);
        
        // Reset range initialization if months changed
        if(JSON.stringify(state.months) !== JSON.stringify(months)) {
          state.heatTimeRangeInitialized = false;
        }
        
        state.months = months; if(!months.length){ setStatus('no months detected in source'); return; }
        // 1) Race + zeros overview
        safeSetOption('race', buildRaceOption(months, topByMonth));
        const race = ensureChart('race');
        if(state.zeroMode === 'totals'){
          let totals;
          if(state.keywordFilter.length){
            totals = totalsByMonth(state.zeroRaw,'count', state.keywordFilter);
          } else {
            totals = state.zeroTotals.length ? state.zeroTotals : (state.zeroRaw.length ? totalsByMonth(state.zeroRaw,'count') : []);
          }
          safeSetOption('zeros', buildZerosOption(months, totals, months[0]));
          if(race){ race.off('timelinechanged'); race.on('timelinechanged', (e)=>{ const month = state.months[e.currentIndex]; safeSetOption('zeros', buildZerosOption(state.months, totals, month)); }); }
        } else {
          const { months: zMonths, topByMonth: zTop } = groupByMonthTop(state.zeroRaw, 'count', state.topN, state.keywordFilter);
          if(zMonths.length){ safeSetOption('zeros', buildZeroRaceOption(zMonths, zTop)); }
          if(race){ race.off('timelinechanged'); }
        }
        // 2) Keyword trails
        const trailSeries = computeTrailsSeries(state.sourceRaw, months, state.trailsN, state.keywordFilter);
        safeSetOption('trails', buildTrailsOption(months, trailSeries));
        syncTrailsPager(trailSeries.length);
        // 3) Heatmap (zero results) with word and month range
        updateHeatTimeRangeControls();
        if(state.zeroRaw.length){
          const { yCats, matrix } = computeHeatmapMatrix(state.zeroRaw, months, state.heatTopK, state.heatTimeStartIdx, state.heatTimeEndIdx, state.keywordFilter);
          safeSetOption('heatmap', buildHeatmapOption(months, yCats, matrix));
        }
        const start = months[0];
        const end = months[months.length - 1];
        setStatus(`rendered: months=${months.length}, rows=${state.sourceRaw.length}, start date=${start}, end date=${end}`);
      }

      // Inputs wiring
      $('#topN').addEventListener('input', e=>{ state.topN = +e.target.value; $('#topNVal').textContent = e.target.value; renderAll(); });
      $('#speed').addEventListener('input', e=>{ state.playInterval = +e.target.value; $('#speedVal').textContent = (state.playInterval/1000).toFixed(1)+"s"; renderAll(); });
      $('#trailsN').addEventListener('input', e=>{ state.trailsN = +e.target.value; $('#trailsNVal').textContent = e.target.value; renderAll(); });
      $('#heatTopK').addEventListener('input', e=>{ state.heatTopK = +e.target.value; $('#heatTopKVal').textContent = e.target.value; state.heatTimeRangeInitialized = false; renderAll(); });
      $('#heatTimeStart').addEventListener('input', e=>{ state.heatTimeStartIdx = +e.target.value - 1; if(state.heatTimeStartIdx>state.heatTimeEndIdx) state.heatTimeEndIdx = state.heatTimeStartIdx; renderAll(); });
      $('#heatTimeEnd').addEventListener('input', e=>{ state.heatTimeEndIdx = +e.target.value - 1; if(state.heatTimeEndIdx<state.heatTimeStartIdx) state.heatTimeStartIdx = state.heatTimeEndIdx; renderAll(); });
      $('#btn-play').addEventListener('click', ()=>{ state.timelinePlaying = !state.timelinePlaying; $('#btn-play').textContent = state.timelinePlaying ? '⏸ Pause' : '▶ Play'; renderAll(); });
      document.getElementById('btn-share-page').addEventListener('click', sharePage);

      const keywordInput = document.getElementById('keywordFilterInput');
      const keywordReset = document.getElementById('keywordFilterReset');
      const keywordDropdown = document.getElementById('keywordOptions');
      if(keywordInput){
        keywordInput.addEventListener('click', e=>{
          e.stopPropagation();
          keywordDropdown?.classList.toggle('open');
        });
      }
      if(keywordDropdown){
        keywordDropdown.addEventListener('click', e=> e.stopPropagation());
      }
      document.addEventListener('click', ()=> keywordDropdown?.classList.remove('open'));
      if(keywordReset){
        keywordReset.addEventListener('click', ()=>{
          state.keywordFilter = [];
          updateKeywordDisplay();
          keywordDropdown?.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked=false);
          const s = keywordDropdown?.querySelector('#keywordSearch');
          if(s){ s.value=''; keywordDropdown.querySelectorAll('label').forEach(l=> l.style.display=''); }
          renderAll();
        });
      }

      // Legend pager (Trails)
      document.getElementById('trailsPrev').addEventListener('click', ()=>{ if(state.trailsLegendPage>0){ state.trailsLegendPage--; renderAll(); } });
      document.getElementById('trailsNext').addEventListener('click', ()=>{ if(state.trailsLegendPage < state.trailsLegendTotalPages-1){ state.trailsLegendPage++; renderAll(); } });

      // File inputs
      $('#file-source').addEventListener('change', async (e)=>{ 
        const f = e.target.files[0]; 
        if(!f) { updateFileStatus('source-display', 'No file chosen'); return; }
        state.manualSource = true; setStatus('reading Popular Search Keywords…'); 
        updateFileStatus('source-display', `Loading ${f.name}...`);
        try{ 
          const buf = await f.arrayBuffer(); 
          const wb = XLSX.read(buf,{type:'array'}); 
          const rows = XLSX.utils.sheet_to_json(wb.Sheets['Raw'], { defval:null }); 
          state.sourceRaw = rows.map(r=>({ month:r.month, keyword:sanitizeKeyword(r.keyword), percentage: asNumber(r.percentage) }));
          setStatus(`loaded Popular: ${state.sourceRaw.length} rows`); 
          updateFileStatus('source-display', `${f.name} (${state.sourceRaw.length} rows)`);
          renderAll(); 
        }catch(err){ console.error(err); setStatus('error reading Popular file'); updateFileStatus('source-display', 'Error loading file'); } 
      });

      $('#file-zero').addEventListener('change', async (e)=>{ 
        const f = e.target.files[0]; 
        if(!f) { updateFileStatus('zero-display', 'No file chosen'); return; }
        state.manualZero = true; setStatus('reading Zero‑Result Keywords…'); 
        updateFileStatus('zero-display', `Loading ${f.name}...`);
        try{ 
          const buf = await f.arrayBuffer(); 
          const wb = XLSX.read(buf,{type:'array'}); 
          if(wb.Sheets['Monthly_Summary']){ 
            const sum = XLSX.utils.sheet_to_json(wb.Sheets['Monthly_Summary'], { defval:null }); 
            state.zeroTotals = sum.map(r=>({ month: toMonthKey(r.month), value: asNumber(r.sum_count||0) })); 
          } 
          const raw = XLSX.utils.sheet_to_json(wb.Sheets['Raw'], { defval:null }); 
          state.zeroRaw = raw.map(r=>({ month:r.month, keyword:sanitizeKeyword(r.keyword), count: asNumber(r.count||0) }));
          setStatus(`loaded Zero: raw ${state.zeroRaw.length}, totals ${state.zeroTotals.length}`); 
          updateFileStatus('zero-display', `${f.name} (${state.zeroRaw.length} rows)`);
          renderAll(); 
        }catch(err){ console.error(err); setStatus('error reading Zero file'); updateFileStatus('zero-display', 'Error loading file'); } 
      });

      // --- Default file autoload (for GitHub Pages) ---
      const DEFAULT_SOURCE_CANDIDATES = ['./data/source_search_keywords_marketplace.xlsx','./source_search_keywords_marketplace.xlsx'];
      const DEFAULT_ZERO_CANDIDATES   = ['./data/zero_result_keywords_marketplace.xlsx','./zero_result_keywords_marketplace.xlsx'];

      async function fetchFirst(urls){
        for(const u of urls){
          try{ const res = await fetch(u, {cache:'no-cache'}); if(res.ok){ return await res.arrayBuffer(); } }catch(e){}
        }
        throw new Error('defaults not found');
      }

      async function tryLoadDefaultSource(){
        setStatus('loading default Popular…');
        const buf = await fetchFirst(DEFAULT_SOURCE_CANDIDATES);
        const wb = XLSX.read(buf,{type:'array'});
        const rows = XLSX.utils.sheet_to_json(wb.Sheets['Raw'], { defval:null });
        state.sourceRaw = rows.map(r=>({ month:r.month, keyword:sanitizeKeyword(r.keyword), percentage: asNumber(r.percentage) }));
        setStatus(`default Popular loaded: ${state.sourceRaw.length} rows`);
        updateFileStatus('source-display', 'Default data file loaded (see GitHub README)');
        renderAll();
      }

      async function tryLoadDefaultZero(){
        setStatus('loading default Zero…');
        const buf = await fetchFirst(DEFAULT_ZERO_CANDIDATES);
        const wb = XLSX.read(buf,{type:'array'});
        if(wb.Sheets['Monthly_Summary']){
          const sum = XLSX.utils.sheet_to_json(wb.Sheets['Monthly_Summary'], { defval:null });
          state.zeroTotals = sum.map(r=>({ month: toMonthKey(r.month), value: asNumber(r.sum_count||0) }));
        }
        const raw = XLSX.utils.sheet_to_json(wb.Sheets['Raw'], { defval:null });
        state.zeroRaw = raw.map(r=>({ month:r.month, keyword:sanitizeKeyword(r.keyword), count: asNumber(r.count||0) }));
        setStatus(`default Zero loaded: raw ${state.zeroRaw.length}, totals ${state.zeroTotals.length}`);
        updateFileStatus('zero-display', 'Default data file loaded (see GitHub README)');
        renderAll();
      }

      async function loadDefaults(forceLoad = false){
        let any = false;
        const shouldLoadSource = forceLoad || (!state.sourceRaw.length && !state.manualSource);
        const shouldLoadZero = forceLoad || (!state.zeroRaw.length && !state.manualZero);
        
        if(shouldLoadSource){ 
          try{ 
            await tryLoadDefaultSource(); 
            any = true; 
          } 
          catch(e){ 
            console.info('No default Popular found'); 
            updateFileStatus('source-display', forceLoad ? 'Default files not found' : 'No file chosen');
          } 
        }
        if(shouldLoadZero){ 
          try{ 
            await tryLoadDefaultZero(); 
            any = true; 
          } 
          catch(e){ 
            console.info('No default Zero found'); 
            updateFileStatus('zero-display', forceLoad ? 'Default files not found' : 'No file chosen');
          } 
        }
        
        if(forceLoad && !any) {
          setStatus('No default files found in /data/ directory');
        } else if(!forceLoad && !any) {
          setStatus('ready — upload files or Load demo');
        }
        
        return any;
      }

      async function autoLoadDefaults(){
        if(state.defaultsTried) return; 
        state.defaultsTried = true;
        await loadDefaults(false);
      }

      // Demo data & tests
      const demo = { sourceRaw:[
        {month:'2023-08-01', keyword:'scriptrunner', percentage:3.30},
        {month:'2023-08-01', keyword:'jira', percentage:3.03},
        {month:'2023-08-01', keyword:'structure', percentage:2.95},
        {month:'2023-08-01', keyword:'automation', percentage:2.74},
        {month:'2023-08-01', keyword:'portfolio', percentage:2.55},
        {month:'2023-09-01', keyword:'scriptrunner', percentage:3.90},
        {month:'2023-09-01', keyword:'jira', percentage:3.60},
        {month:'2023-09-01', keyword:'automation', percentage:2.80},
        {month:'2023-09-01', keyword:'structure', percentage:2.30},
        {month:'2023-09-01', keyword:'tempo', percentage:2.00},
        {month:'2023-10-01', keyword:'scriptrunner', percentage:3.40},
        {month:'2023-10-01', keyword:'automation', percentage:3.10},
        {month:'2023-10-01', keyword:'jira', percentage:2.70},
        {month:'2023-10-01', keyword:'structure', percentage:2.20},
        {month:'2023-10-01', keyword:'eazybi', percentage:1.80},
        {month:'2023-11-01', keyword:'automation', percentage:3.50},
        {month:'2023-11-01', keyword:'scriptrunner', percentage:3.10},
        {month:'2023-11-01', keyword:'jira', percentage:2.80},
        {month:'2023-11-01', keyword:'tempo', percentage:2.20},
        {month:'2023-11-01', keyword:'structure', percentage:1.90},
        {month:'2023-12-01', keyword:'automation', percentage:3.70},
        {month:'2023-12-01', keyword:'jira', percentage:3.20},
        {month:'2023-12-01', keyword:'scriptrunner', percentage:2.90},
        {month:'2023-12-01', keyword:'structure', percentage:2.10},
        {month:'2023-12-01', keyword:'portfolio', percentage:1.60}
      ], zeroRaw:[
        {month:'2023-08-01', keyword:'cost tracker', count:40},
        {month:'2023-08-01', keyword:'rpa', count:80},
        {month:'2023-09-01', keyword:'rpa', count:120},
        {month:'2023-10-01', keyword:'rpa', count:60},
        {month:'2023-10-01', keyword:'okrs', count:40},
        {month:'2023-12-01', keyword:'okrs', count:200}
      ], zeroTotals:[
        {month:'2023-08', value:1719}, {month:'2023-09', value:1481}, {month:'2023-10', value:554}, {month:'2023-11', value:2}, {month:'2023-12', value:730}
      ] };

      document.getElementById('btn-load-defaults').addEventListener('click', async ()=>{
        setStatus('Loading default files from /data/ directory...');
        // Reset manual flags to allow loading over existing data
        state.manualSource = false; 
        state.manualZero = false;
        const loaded = await loadDefaults(true);
        if(loaded) {
          setStatus('Default files loaded successfully');
        }
      });

      document.getElementById('btn-demo').addEventListener('click', ()=>{
          state.sourceRaw = demo.sourceRaw.map(r=>({...r, keyword:sanitizeKeyword(r.keyword)}));
          state.zeroRaw = demo.zeroRaw.map(r=>({...r, keyword:sanitizeKeyword(r.keyword)}));
        state.zeroTotals = demo.zeroTotals.slice();
        updateFileStatus('source-display', 'Demo data loaded');
        updateFileStatus('zero-display', 'Demo data loaded');
        state.timelinePlaying = true; document.getElementById('btn-play').textContent = '⏸ Pause'; renderAll();
      });

      function runSmokeTests(){
        const out = []; const ok = (name, cond)=>{ out.push(`${cond? '✅':'❌'} ${name}`); if(!cond) console.error('Test failed:', name); };
        ok('race container exists', !!document.getElementById('race'));
        ok('zeros container exists', !!document.getElementById('zeros'));
        ok('trails container exists', !!document.getElementById('trails'));
        ok('heatmap container exists', !!document.getElementById('heatmap'));
        ok('inputs help exists', !!document.querySelector('[data-testid="help-inputs"]'));
        ok('dynamics help exists', !!document.querySelector('[data-testid="help-dynamics"]'));
        ok('trails help exists', !!document.querySelector('[data-testid="help-trails"]'));
        ok('heatmap help exists', !!document.querySelector('[data-testid="help-heatmap"]'));
        try{ /* empty render */ renderAll(); ok('renderAll without data does not throw', true); }catch(e){ ok('renderAll without data does not throw', false); }
        // Verify wrapLabel inserts a newline for long strings
        const wl = wrapLabel('this is a very very long keyword title that should wrap into two lines', 18);
        ok('wrapLabel inserts newline', wl.includes('\n'));
        // With demo
          state.sourceRaw = demo.sourceRaw.map(r=>({...r, keyword:sanitizeKeyword(r.keyword)}));
          state.zeroRaw = demo.zeroRaw.map(r=>({...r, keyword:sanitizeKeyword(r.keyword)}));
          state.zeroTotals = demo.zeroTotals.slice();
        try{ renderAll(); const race = ensureChart('race'); const zeros = ensureChart('zeros'); const trails = ensureChart('trails'); const heat = ensureChart('heatmap'); ok('race chart instance created', !!race); ok('zeros chart instance created', !!zeros); ok('trails chart instance created', !!trails); ok('heatmap chart instance created', !!heat); }catch(e){ ok('render with demo data succeeds', false); }
        // Time range controls reflect months
        const s = document.getElementById('heatTimeStart'); const e = document.getElementById('heatTimeEnd');
        ok('heatTimeStart max set', +s.max === state.months.length);
        ok('heatTimeEnd max set', +e.max === state.months.length);
        setStatus('Smoke tests results:\n' + out.join('\n'));
      }
      document.getElementById('btn-test').addEventListener('click', runSmokeTests);

      // Make file displays clickable
      document.getElementById('source-display').addEventListener('click', ()=>{ document.getElementById('file-source').click(); });
      document.getElementById('zero-display').addEventListener('click', ()=>{ document.getElementById('file-zero').click(); });

      initHelp();

      // Try to autoload defaults on boot (works on GitHub Pages when files are in repo)
      autoLoadDefaults();

      window.addEventListener('resize', ()=>{ state.charts.race?.resize?.(); state.charts.zeros?.resize?.(); state.charts.trails?.resize?.(); state.charts.heatmap?.resize?.(); });
    }
  })();
  </script>
</body>
</html>
